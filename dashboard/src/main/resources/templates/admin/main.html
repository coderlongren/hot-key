<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<link th:href="@{/static/admin/assets/css/style.css}" rel="stylesheet"/>
<link th:href="@{/static/admin/assets/css/bootstrap.css}" rel="stylesheet"/>
<link th:href="@{/static/admin/assets/css/font-awesome.css}" rel="stylesheet"/>
<link rel="stylesheet" type="text/css" th:href="@{/static/admin/assets/js/bootstrap/bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css}">
<body id="listbody" th:fragment="main">

<!-- 右边内容 -->
<div class="wrap-fluid">
    <div class="container-fluid bevel tlbr" style="min-height: 600px;position:relative;overflow: hidden;background-position-x: left">
        <div class="content-wrap">
            <div class="body-nest" id="search_div"  style="display: block">
                <div class="form_left" style="margin-left: 5%; margin-top: 3%">
                    <form role="form" class="form-inline">
                        <div class="form-group">
                            <label class="control-label" style="float: left;padding-top: 15px">日期：</label>
                            <span class='input-group date datetimepicker' style="width: 14%;float: left" id='datetimepicker1' data-date-format="yyyy-mm-dd hh:ii:ss">
                        <input type='text' class="form-control" name="startTime"/>
                        <span class="input-group-addon">
                           <span class="glyphicon glyphicon-calendar"></span>
                        </span>
                        </span>
                            <label class="control-label" style="float: left;padding-top: 10px">~</label>
                            <span class='input-group date datetimepicker'  style="width: 14%;float: left"  id='datetimepicker2' data-date-format="yyyy-mm-dd hh:ii:ss">
                        <input type='text' class="form-control"  name="endTime"/>
                        <span class="input-group-addon">
                           <span class="glyphicon glyphicon-calendar"></span>
                        </span>
                        </span>

                            <div class="form-group" style="margin-left: 3%; padding-top: 5px;width: 36%">
                                <label class="control-label" style="float: left;padding-top: 10px">固定时间查询：</label>
                                <select name="type"  class="form-control" style="width: 100px" id="type">
                                    <option value="1">近30分</option>
                                    <option value="2">近1天</option>
                                    <option value="3">近7天</option>
                                </select>
                                <button onclick="ruleSearch()" class="btn btn-success" type="button" style="margin-left: 15%"><i class="fa fa-search"></i>&nbsp;查询</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="nest" id="Blank_PageClose" style="height: 1000px;" >
                <div id="ruleLineChart" style="width: 90%;height:50%;margin-left: 5%">
                </div>
                <div id="mainRules" style="width: 90%;height:20%;margin-left: 9%">
                </div>
            </div>
        </div>
    </div>
</div>

<script th:src="@{/static/admin/assets/js/echarts.min.js}" type="text/javascript"></script>
<script th:src="@{/static/admin/assets/js/jquery.min.js}" type="text/javascript"></script>
<script th:src="@{/static/admin/assets/js/bootstrap/js/base_list.js}" type="text/javascript"></script>
<script th:src="@{/static/admin/assets/js/bootstrap/bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js}" type="text/javascript"></script>
<script th:src="@{/static/admin/assets/js/bootstrap/bootstrap-datetimepicker/js/bootstrap-datetimepicker.zh-CN.js}" type="text/javascript"></script>


<script type="text/javascript">

    let globalRules = [];
    $.ajax({
        cache : true,
        type : "POST",
        url : "/rule/listRules",
        headers: {
            "Authorization":getCookie("token")
        },
        async : false,
        error : function(request) {
            $.modal.alertError("系统错误");
        },
        success : function(data) {
            console.log(data)
            for (let i = 0; i < data.length; i++) {
                let colo =  '#'+(function(h){
                    return new Array(7-h.length).join("0")+h
                })((Math.random()*0x1000000<<0).toString(16))
                let html = '<div style="float: left;width: 20%; margin-top: 3%" ' +
                    ' rule ="'+data[i]+'"   color ="'+colo+'" ckStatus = 0  onclick="ckRule(this)">' +
                    '<span style="margin-left: 8%;font-size: 25px;float: left">' + data[i] + '</span>' +
                    '<span style="display: block; margin-left:34%; height:7px;' +
                    ' border-bottom:2px solid '+colo+';width:90px;margin-block-end:7px "></span></div>';
                $("#mainRules").append(html);
            }
        }
    });

        // 基于准备好的dom，初始化echarts实例
        var myChart = echarts.init(document.getElementById('ruleLineChart'));
        // 指定图表的配置项和数据
        var option = {
            xAxis: {
                type: 'category',
                data: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']
            },
            yAxis: {
                type: 'value'
            },
            tooltip: {
                trigger: 'axis'   // axis   item   none三个值
            },
            series: [
                {
                    name: 'key1',
                    data: [300, 265, 350, 874, 299, 500, 700],
                    type: 'line'
                }
            ]
        };
        //加载数据
        loadData(option, "", {"type":1});
        // 使用刚指定的配置项和数据显示图表。
        myChart.setOption(option);


    $('.datetimepicker').datetimepicker({
            language: 'zh-CN',
            CustomFormat: 'yyyy-mm-dd HH:ii:ss',
            weekStart: 1,
            todayBtn: 1,            //显示当天按钮，点击则选择当天当天时间
            autoclose: 1,           //选完时间自动关闭
            todayHighlight: 1,      //当天时间高亮
            startView: 2,           //从月视图开始，选天
            minView: 0,             //提供选择分钟的视图
            forceParse: 0,
            minuteStep: 1           //用于构建小时视图。就是最小的视图是每1分钟可选一次。是以分钟为单位的
    });


    function loadData(option,color,param){
        param.rules = JSON.stringify(globalRules);
        $.ajax({
            type : "post",
            async : false, //同步执行
            url : "/key/ruleLineChart",
            data : param,
            headers: {
                "Authorization":getCookie("token")
            },
            dataType : "json", //返回数据形式为json
            success : function(result) {
                if (result) {
                    //初始化option.xAxis[0]中的data
                    option.xAxis.data = result.xAxis;
                    //初始化option.series[0]中的data
                    option.series=[];
                    let i = 0;
                    for(let key in result.series){
                        i++;
                        let seriesData = {"name":key, "data": result.series[key],"type":"line"};
                        option.series.push(seriesData);
                        console.log(option.series);
                    }

                }
            },
            error: function(result){  //加载失败时执行
                let token = getCookie("token");
                if(result.status == 500 && ( token == "undefined" || token =="")){
                    top.location.href = '/user/login';
                }
                console.info("加载数据失败");
            }
        });
    }

    function ckRule(doc){
        let rule = $(doc).attr("rule");
        let color = $(doc).attr("color");
        let ckStatus = $(doc).attr("ckStatus");
        if(ckStatus == 0){
            globalRules.push(rule);
            $(doc).attr("ckStatus",1);
        }else{
            globalRules.forEach(function(item, index, arr) {
                if(item == rule) {
                    arr.splice(index, 1);
                }
            });
            $(doc).attr("ckStatus",0);
        }
        let st = $("#datetimepicker1").val();
        let et = $("#datetimepicker2").val();
        let type = $("#type").val();
        let param = {"startTime":st,"endTime":et,"type":type};
        loadData(option,color,param);
        myChart.setOption(option);
    }



    function ruleSearch(){
        let st = $("#datetimepicker1").val();
        let et = $("#datetimepicker2").val();
        let type = $("#type").val();
        let param = {"startTime":st,"endTime":et,"type":type};
        loadData(option,"",param);
        myChart.setOption(option);
    }

</script>

</body>

</html>
